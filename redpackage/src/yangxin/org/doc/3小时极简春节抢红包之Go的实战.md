# 3小时极简春节抢红包之Go的实战
## 第1章 课程介绍
- 历年春节红包大战
    - 2014
        - 微信红包率先点燃战火
        - 除夕到初八
        - 超过800万用户参与
        - 超过4000万个红包被领取
    - 2015
        - 各种红包满天飞
        - 微信、QQ、支付宝钱包、微博、百度
        - 上百亿元红包
        - 3月18日都市爆笑喜剧电影《红包》
    - 2016
        - 红包硝烟越烧越旺
        - 支付宝2.688亿，集五福活动
        - 4.2亿人，80.8亿个，2015年的8倍
        - 每秒钟40.9万个，1.8亿人参与摇一摇
    - 2017年
        - 黑科技红包
        - VR、AR
        - 抢红包成为春节必备
    - 2018
        - 京东加入
        - 各显身手
    - 2019年
        - 百度接力春晚，关键字红包，19亿
        - 集好运卡、团圆红包：10亿
        - 好运临门，星想事成，祝福祖国，梦想成真：9亿，208亿次
        - 元宵节：2亿
    - 2020年
        - 今日头条短视频点赞红包？
        - 华为？蓝绿厂？刷脸红包？
        - ……
- 课程介绍
    - 红包业务为背景按照软件研发的流程（需求分析->概要设计->详细设计->开发->测试）
    - 需求分析方法和用例定义方法
    - 四色建模法和核心模型设计
    - 系统架构设计
    - 数据库物理模型设计
    - Golang编程实践
    - 资金交易安全问题探讨
    - 超卖问题的解决方案
    - 表结构设计中的性能优化考虑
    - 红包拆解和红包算法
    - 系统设计和算法的选择
- 红包系统演进之路
    - 满足红包业务需求，快速迭代上线
    - 出现超卖现象，事务锁来帮忙
    - 流量增加，收红包出现性能瓶颈，改为乐观锁，性能提高3倍
    - 流量继续增加，乐观锁也扛不住了，那就上缓存吧
    - 缓存还没跑溜，服务器挂了，数据丢失了？
    - 分布式消息队列来解决异步写
    - 数据分片来解决数据库横向扩展？
    - Golang编码实战从0到1构建红包秒杀系统
- 课程能学到什么？
    - 1 红包业务系统的需求分析方法和用例定义方法
    - 2 学习四色建模法的基本知识，并结合红包业务场景把需求转化为业务模型来深入学习四色建模方法
    - 3 学习在四色建模法建模过程中如何绘制时间轴事件模型图？
    - 4 通过业务模型如何来拆分业务系统模块？然后通过业务模型来学习如何来定义业务边界？
    - 5 从业务模型和架构目标和愿景来学习架构设计过程、设计方法？
    - 6 学习如何从业务模型推导物理模型？
    - 7 如何从数据库物理模型设计上和系统架构设计上来优化性能？
    - 8 如何解决资金交易安全（超卖）问题和资金交易上的性能优化？并结合超卖方案来学习使用Golang编程语言来做基准测试
    - 9 如何在不同的场景和时机中设计和应用红包算法？
    - 10 学习Golang项目如何构建？
    - 11 在Golang中如何设计和解决基础公共资源的访问问题？
    - 12 学习使用Golang接口来设计基础资源加载和启动的基础设施组件，学习对基础资源组件生命周期的管理的设计？
- 课程章节简介
    - 第一章 课程介绍
    - 第二章 业务场景需求分析
    - 第三章 业务模型分析和设计
    - 第四章 数据库设计
    - 第五章 总体架构和设计
    - 第六章 Golang编码实践
    - 第七章 课程总结
## 第2章 业务场景需求分析
- 红包业务场景分析
    - 红包业务场景
        - 场景概述
        - 场景分类：祝福、庆祝、营销、显摆、曝光、求问等
        - 场景分析
- 用例定义和分析方法概述
    - 用例定义的主要元素
        - 用例名称
        - 场景概述
        - 用例描述
        - 用例价值
        - 约束和限制
- 发红包业务场景概述
    - 场景概述
        - 按红包类型：普通红包和碰运气红包
- 发红包业务场景用例定义
    - 正常逻辑定义——正确发送
        - 场景：用户发一定数量和金额的红包给1个或多个人
        - 用例描述
        - 约束限制：合法用户，红包总数量（100），红包总金额（100）
    - 异常逻辑定义1——用户余额不足
        - 场景：当用户红包时，账户余额不足
        - 用例描述
        - 约束限制：余额不小于红包总金额
    - 异常逻辑定义2——红包未接收
        - 场景：当用户红包后，红包未被接收过期
        - 用例描述
- 收红包业务场景概述
    - 按收红包目标
        - 单向红包
        - 群发红包
    - 按收红包方式
        - 抢红包
    - 正常逻辑定义——抢到红包
        - 场景：当用户点击红包链接后，抢到红包，金额存入账户
        - 用例描述
        - 约束限制：合法用户，群内用户
    - 异常逻辑定义——未抢到红包
        - 场景：当用户点击红包链接后，未抢到红包
        - 用例描述
        - 约束限制
- 摇红包业务场景概述
    - 摇红包场景
        - 和抢红包的异同（特殊情况、流程一致）
        - 摇红包特性（终端、量多、持续、不确定、营销）
        - 用例定义
- 红包资金账户业务需求
    - 满足用户发红包和收红包业务过程中，用于红包资金的交易和记账
- 红包资金账户设计需求
    - 资金交易
        - 交易需求：账户、余额
        - 记账和对账：记录资金交易过程和行为
        - 交易的参与者：交易主体和交易对象
- 红包业务场景总结
    - 红包是小额金融产品：充值卡、购物卡
        - 发红包：从中间商购买和发布
        - 收红包：秒杀、兑换
    - 红包资金账户满足用于红包业务资金的交易和记账
## 第3章 业务模型分析和设计
- 模型分析概述
    - 四色建模法介绍
    - 红包业务总体模型分析和设计
- 子业务模型设计
    - 红包资金账户模型分析和设计
    - 发红包模型分析和设计
    - 收红包模型分析和设计
- 四色建模法介绍-四个概念
    - 时标性对象——时刻时段原型
        - 业务在时间轴上发生的需要跟踪的事件留下的痕迹
        - 图例用粉色来标识
    - 实体对象
        - 业务事件中的参与者：人、事、物
        - 图例用绿色表示
    - 角色
        - 实体在业务流程中所扮演的角色
        - 图例用黄色表示
    - 描述
        - 说明实体、时标性对象的属性
        - 图例用蓝色来标识
- 五个步骤来分析和设计
    - 第一步：寻找需要追溯的事件和足迹，识别出时标性对象
    - 第二步：整理时标对象，得到模型骨干
    - 第三步：寻找和分析出这些事件中的参与者：人、事、物
    - 第四步：抽象出角色，并插入其中
    - 第五步：添加对象描述性信息
- 总结
    - 四色建模法核心方法
    - 红包业务模型
        - 资金账户模型：账户、流水、用户
        - 红包模型：红包、秒杀活动、流转、库存、用户
## 第4章 数据库设计
- 业务模型和数据库物理模型的关系
    - 数据库物理模型和领域业务模型可以保持一致
    - 数据库物理模型和领域业务模型可以不一致
    - 根据业务特点和技术要求合理地调整
- 发红包时数据库操作
    - 插入商品、库存、订单、活动共4次
    - 查询用户的资金账户信息1次
    - 更新账户余额1次，插入账户流出1次
    - 查询活动记录1次
- 收红包时数据库操作
    - 查询用户红包记录1次和锁库存1次
    - 插入收红包记录1次
    - 更新账户余额1次，插入账户流出1次
    - 更新库存和余额1次
## 第5章 总体架构和设计
- 并发性能架构的关键
    - 内存 > 分布式内存 > SSD > HDD
    - 异步 > 同步
    - 分布式 > 单机
- 重点总结
    - 红包系统特点：事务安全和高并发
    - 高并发高性能解决之道概述
        - 数据就近访问
        - 高性能存储
        - 异步减少等待和缓冲
        - 横向扩展：分布式集群
    - 红包系统的一些高并发高性能解决思路
        - 高效存取：分布式缓存和本地缓存
        - 缓冲：消息队列异步化
        - 数据层横向扩展能力：分片
    - 本课程的红包系统架构，单体架构
- 红包业务系统核心问题
    - 高并发资金交易系统
    - 资金交易安全，事务型要求高
- 红包系统中需要解决的超卖问题
    - 保证大并发请求时剩余数量和金额不能出现负数
    - 本质是要保证剩余数量和金额字段不能为负数
- 超卖现象的方案1——程序事务和行锁
    - 行锁是一种悲观锁
        - 假设数据会被其他人修改，先把坑占了
        - 先上锁，再更新，完成后释放锁
        - 适合写多和写冲突比较多的场景
        - 在数据库事务中锁定操作行（for update）
        - 在数据库事务中通过程序来计算和判断
    - 优点
        - 稳定可靠，不会出现超卖
    - 缺点
        - 需要查询和计算：性能差、锁阻塞等待
        - 锁阻塞等待会导致客户端延迟或超时
        - 重试增加系统和网络开销
- 超卖现象的优化2——数据库字段优化
    - 将剩余数量和金额字段类型设置为无符号整数
        - 字段不能为负数
        - 如果被减为小于0，SQL执行会报错
        - 不查询，直接更新
        - 扣减为负数时：value is out of range
        - 优化后端性能提升了2倍
- 超卖现象的优化方案3——乐观锁
    - 乐观锁
        - 假设数据不会被其他人修改，只有自己，操作时验证一下
        - CAS：先比较，再更新
        - 适合写少和写冲突少的场景
- 建议的方案
    - 数据库字段正整数+乐观锁
        - 双重保险
        - 有较好的性能
## 第6章 Golang编码实践
- 算法概述-红包序列
    - 按照红包总金额和总数量通过红包算法计算拆分
    - 计算拆分后的子红包集合叫做红包序列
- 算法概述-计算时机
    - 红包计算的时机
        - 发红包时计算
        - 抢红包时计算
- 算法概述-红包算法要求
    - 业务逻辑要求
        - 保证红包数量的人能拿到红包且金额>0
        - 抢到的总金额不能超过红包总金额
    - 设计逻辑要求
        - 红包序列是随机的，序列元素之间差异性可以控制
        - 算法尽可能简单
            - 大小分布可以预期
            - 尽可能降低性能损耗
    - 计算逻辑如何来设计
        - 计算时需要守住底线，避免0金额红包
        - 2个公式
            - 最大可调度金额=总金额-最小金额*红包数量
            - 平均可调度金额=(总金额-最小金额*红包数量)/红包数量
- 简单随机算法
    - 算法
        - 随机范围为（0~最大可用金额）
        - 随机数+最小金额作为红包序列元素
    - 缺点
        - 金额先大后小
## 第7章 课程总结